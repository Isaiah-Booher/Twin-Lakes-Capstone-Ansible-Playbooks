---
- name: Update Cisco Router Configuration
  hosts: routers
  gather_facts: no
  become: no

  tasks:
    - name: Configure EVPN for EVI 11001
      ios_command:
        commands:
          - conf t
          - evpn
          - evi 11001
          - bgp
          - route-target import 1111:11001
          - route-target export 1111:11001
          - exit
          - control-word-disable
          - advertise-mac
          - exit
          - unknown-unicast-suppression
          - exit

    - name: Configure EVPN for Bundle-Ether400 interface
      ios_command:
        commands:
          - interface Bundle-Ether400
          - ethernet-segment identifier type 0 00.01.10.10.10.10.10.10.10
          - bgp route-target 0001.1010.1010
      register: bundle_eth_config
      changed_when: "'configured' in bundle_eth_config.stdout"

    - name: Save Configuration if Changes Detected
      ios_command:
        commands: write memory
      when: evpn_config.changed or bundle_eth_config.changed
